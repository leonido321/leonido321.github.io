{% extends 'gamification/base.html' %}
{% block title %}–ë–∞—Ç–ª—ã{% endblock %}
{% block content %}
    <h2>‚öîÔ∏è –ê–∫—Ç–∏–≤–Ω—ã–µ –±–∞—Ç–ª—ã</h2>
    
    {% if active_battles %}
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
        {% for battle in active_battles %}
        <div class="card">
            <h3>{{ battle.name }}</h3>
            <p><strong>–¢–∏–ø:</strong> {{ battle.battle_type.name }}</p>
            <p><strong>–í—Ä–µ–º—è:</strong> {{ battle.start_time|date:"d.m H:i" }} - {{ battle.end_time|date:"d.m H:i" }}</p>
            <p><strong>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> {{ battle.participants.count }}</p>
            
            <!-- –¢–∞–π–º–µ—Ä –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –±–∞—Ç–ª–∞ -->
            <div style="background: #ffe082; padding: 10px; border-radius: 8px; margin: 10px 0;">
                <strong>–û—Å—Ç–∞–ª–æ—Å—å:</strong> <span id="timer-{{ battle.id }}">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>

            {% if user in battle.participants.all %}
                {% if battle.user_result %}
                    <div style="background: #e1bee7; padding: 10px; border-radius: 8px; margin-top: 10px;">
                        <strong>–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong> {{ battle.user_result.score }} –æ—á–∫–æ–≤
                    </div>
                {% else %}
                    <p style="color: #6a1b9a; font-weight: bold;">–í—ã —É—á–∞—Å—Ç–≤—É–µ—Ç–µ!</p>
                {% endif %}
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card" style="text-align: center; padding: 30px;">
        <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–∞—Ç–ª–æ–≤ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç</p>
        <img src="https://img.icons8.com/ios/100/000000/swords.png" alt="‚öîÔ∏è" style="width: 80px; opacity: 0.3;">
    </div>
    {% endif %}

    {% if upcoming_battles %}
    <h2 style="margin-top: 40px;">‚è∞ –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –±–∞—Ç–ª—ã</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
        {% for battle in upcoming_battles %}
        <div class="card" style="opacity: 0.8;">
            <h3>{{ battle.name }}</h3>
            <p><strong>–ù–∞—á–∞–ª–æ:</strong> {{ battle.start_time|date:"d.m H:i" }}</p>
            <p><strong>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> {{ battle.end_time|timeuntil:battle.start_time }}</p>
            <p><strong>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> {{ battle.participants.count }}</p>
            
            <!-- –¢–∞–π–º–µ—Ä –¥–æ —Å—Ç–∞—Ä—Ç–∞ –±–∞—Ç–ª–∞ -->
            <div style="background: #a5d6a7; padding: 10px; border-radius: 8px; margin: 10px 0;">
                <strong>–°—Ç–∞—Ä—Ç —á–µ—Ä–µ–∑:</strong> <span id="countdown-{{ battle.id }}">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            
            <form method="post" action="{% url 'gamification:join_battle' battle.id %}">
                {% csrf_token %}
                <button type="submit" style="background: #7b1fa2; color: white; border: none; padding: 8px 15px; border-radius: 6px; width: 100%;">
                    –ó–∞–ø–∏—Å–∞—Ç—å—Å—è
                </button>
            </form>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if completed_battles %}
    <h2 style="margin-top: 40px;">üèÜ –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –±–∞—Ç–ª—ã</h2>
    {% for battle in completed_battles %}
    <div class="card">
        <h3>{{ battle.name }}</h3>
        <p><strong>–î–∞—Ç–∞:</strong> {{ battle.start_time|date:"d.m.Y" }}</p>
        <p><strong>–¢–æ–ø-3:</strong></p>
        <ol>
            {% for result in battle.battleresult_set.all|slice:":3" %}
            <li>
                {{ result.user.get_full_name|default:result.user.username }} ‚Äî 
                {{ result.score }} –æ—á–∫–æ–≤ 
                {% if forloop.counter == 1 %} ü•á{% elif forloop.counter == 2 %} ü•à{% elif forloop.counter == 3 %} ü•â{% endif %}
            </li>
            {% endfor %}
        </ol>
        <a href="{% url 'gamification:leaderboard' %}" class="btn-home" style="background: #5e35b1; margin-top: 10px; display: inline-block;">
            –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤
        </a>
    </div>
    {% endfor %}
    {% endif %}

    <!-- –°–ö–†–ò–ü–¢–´ –¢–û–õ–¨–ö–û –í –ö–û–ù–¶–ï -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // –¢–∞–π–º–µ—Ä—ã –¥–ª—è –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –±–∞—Ç–ª–æ–≤ (–¥–æ —Å—Ç–∞—Ä—Ç–∞)
            {% for battle in upcoming_battles %}
            (function() {
                const countdownEl = document.getElementById('countdown-{{ battle.id }}');
                if (!countdownEl) return;

                const end = new Date("{{ battle.start_time|date:'c' }}").getTime();

                const timer = setInterval(function() {
                    const now = new Date().getTime();
                    const distance = end - now;

                    if (distance < 0) {
                        clearInterval(timer);
                        countdownEl.textContent = "–ë–∞—Ç–ª –Ω–∞—á–∞–ª—Å—è!";
                        location.reload();
                        return;
                    }

                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    countdownEl.textContent = `${days}–¥ ${hours}—á ${minutes}–º ${seconds}—Å`;
                }, 1000);
            })();
            {% endfor %}

            // –¢–∞–π–º–µ—Ä—ã –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–∞—Ç–ª–æ–≤ (–¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è)
            {% for battle in active_battles %}
            (function() {
                const timerEl = document.getElementById('timer-{{ battle.id }}');
                if (!timerEl) return;

                const end = new Date("{{ battle.end_time|date:'c' }}").getTime();

                const interval = setInterval(function() {
                    const now = new Date().getTime();
                    const distance = end - now;

                    if (distance < 0) {
                        clearInterval(interval);
                        timerEl.textContent = "–ë–∞—Ç–ª –∑–∞–≤–µ—Ä—à—ë–Ω!";
                        location.reload();
                        return;
                    }

                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    timerEl.textContent = `${days}–¥ ${hours}—á ${minutes}–º ${seconds}—Å`;
                }, 1000);
            })();
            {% endfor %}
        });
    </script>
{% endblock %}  <!-- –≠–¢–û–¢ –¢–ï–ì –ë–´–õ –ü–†–û–ü–£–©–ï–ù! -->